<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>MongoDB Map-Reduce 原理及提速 | Vimer.Me</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="煮酒编码空望月，疯疯癫癫醉人生">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="MongoDB Map-Reduce 原理及提速 | Vimer.Me">
    <meta name="twitter:description" content="煮酒编码空望月，疯疯癫癫醉人生">

    <meta property="og:type" content="article">
    <meta property="og:title" content="MongoDB Map-Reduce 原理及提速 | Vimer.Me">
    <meta property="og:description" content="煮酒编码空望月，疯疯癫癫醉人生">

    
    <meta name="author" content="vimer.me">
    
    <link rel="stylesheet" href="../../../css/vno.css" type="text/css">

    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" type="text/css">


    
    <link rel="icon" href="/images/avatar-small.png">
    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="Vimer.Me" href="/atom.xml">
    

    <link rel="canonical" href="http://vimer.me/2015/01/mongodb-map-reduce-increase-speed/"/>

                 
</head>

<body class="home-template no-js">
    <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>

    <script src="../../../js/main.js" type="text/javascript"></script>

    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 Vimer.Me 的主页"><img src="/images/avatar.jpg" width="80" alt="Vimer.Me logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for Vimer.Me">Vimer.Me</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">基础·极致·分享</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">煮酒编码空望月，疯疯癫癫醉人生</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">博客</a></li>
            
              <li class="navigation__item"><a href="/favourite">黄金屋</a></li>
            
              <li class="navigation__item"><a href="/favourite/time.html">时光机</a></li>
            
              <li class="navigation__item"><a href="/aboutme">关于我</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  

  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/monniya" title="查看我的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  
<!-- Twitter -->

  <li class="navigation__item">
    <a href="https://twitter.com/onlymonniya" title="上Twitter找我" target="_blank">
      <i class='social fa fa-twitter'></i>
      <span class="label">Twitter</span>
    </a>
  </li>

  

  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>



  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-purple"></div>
  </div> 
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2015-01-18T04:07:42.000Z" class="post-list__meta--date date">1月18 2015</time> &#8226; <span class="post-meta__tags tags">于&nbsp;
  <a class="-link" href="../../../tags/Map-Reduce">Map-Reduce</a>, <a class="-link" href="../../../tags/MongoDB">MongoDB</a>
 </span>
      <span class="page-pv">
      &nbsp;阅读&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>
      </span> 
   
    </div>
    <h1 class="post-title">MongoDB Map-Reduce 原理及提速</h1>
  </header>

  <section class="post">
    <p>想要优化Map-reduce就要深入理解其原理.</p>
<p>Map-Reduce基本原理请见下图:</p>
<a id="more"></a>
<p><img src="http://ww4.sinaimg.cn/large/744e593bgw1eodjvvjkrij20r80jgdj7.jpg" alt="Map-Reduce基本原理"></p>
<p>整个数据处理流程可以参见官方上图,先对要进行处理的数据进行Query,然后针对Query的数据进行map,最后针对map的数据进行reduce.</p>
<p>简单了解之后,我们这里取一个例子熟悉下整个过程:</p>
<p>数据基本格式为:</p>
<pre>
<code class="js">
/* 0 */
{
    "code" : "A",
    "uid" : "id_1",
    "count" : 1
}

/* 1 */
{
    "code" : "A",
    "uid" : "id_1",
    "count" : 1
}

/* 2 */
{
    "code" : "B",
    "uid" : "id_1",
    "count" : 1
}

/* 3 */
{
    "code" : "B",
    "uid" : "id_2",
    "count" : 2
}
</code>
</pre>

<p>目的:根据uid计算出count的和 且 这个合涉及到哪些code.</p>
<p>很快就可以写出Map和Reduce函数:</p>
<pre>
<code class="javascript">
var map = function() {
    emit(this.uid, {"code":this.code || "", count:this.count || 1});
};

var reduce = function(key, values) {
    var result = {code:{}, count:0};
    values.forEach(function(val) {
                result.code[val.code] = 1;
                result.count += val.count;
                });
    return result;
}
</code>
</pre>

<p>结果为:</p>
<pre>
<code class="javascript">
/* 0 */
{
    "_id" : "id_1",
    "value" : {
        "code" : {
            "A" : 1,
            "B" : 1
        },
        "count" : 3
    }
}

/* 1 */
{
    "_id" : "id_2",
    "value" : {
        "code" : "B",
        "count" : 2
    }
}
</code>
</pre>

<p>这次我省去了query的过程,直接进行Map和Reduce,我们来拆解下过程:</p>
<p>首先,MongoDB会扫描整个数据表(这里省去Query)遍历所有documents,对于每个docuemnt都会根据key(uid)进行map存储.</p>
<p>其次,这个时候MongoDB会对记录的size进行检查( mongod checks every 100 records that the size of the map is not over 50KB, if so it runs reduce on ALL current keys. If size of map is still over 100KB, it dumps all current documents to disk in an “incremental” collection.)</p>
<p>最后根据map的数据进行reduce操作.</p>
<p>好,上面三点是大概的过程,对于Mapping过程,上面实例中会进行</p>
<pre>
<code class="javascript">
{"id_1", values:[{"code":"A", "count":1}, {"code":"A", "count":1}, {"code":"B", "count":1}}
</code>
</pre>

<p>这样的Emit操作.这点是需要注意的.然后以这样得方式传入到Reduce进行处理,所以Reduce必须对values进行forEach处理.</p>
<p>通过上面这个过程,还有一点要非常注意:如果有很多文档,而且这些文档的分布是非常随机的,当内存比较小时,MongoDB会采取把这些数据存在一个inc自增的文档中.</p>
<p>比方说:我有A, B, C三个key, 每个key有100个, 但是这些key都是随机分布的 比如A…B…A…B..C…A..B..C..当我要先对A进行Emit时需要把所有是A的key的document获取出来,那么这个过程当内存很小时 需要把大部分得document存储到磁盘上.然后内存和磁盘一直交换数据,至到把A全部找出为止(期间每在内存中操作的部分A会先Emit出去).</p>
<p>这种操作肯定很耗时, 如果我们对key进行索引且排好序,那么排好序的A就会大部分在内存中,减少了内存和磁盘的切换次数.</p>
<p>所以对大数据加排序是必须要有的.这个细节至少可以提高很多倍得处理速度.</p>
<p>基本原理先说到这,还有更多实践干货留着下次说.</p>

  </section>

</article>

<section class="read-more">
           
    
               
            <div class="read-more-item">
                <span class="read-more-item-dim">最近的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2015/03/startup-1-24pi-tearm-will-be-great/" title="创业路「一」：24pi - 团队合作才能大作, 这是种胸怀">创业路「一」：24pi - 团队合作才能大作, 这是种胸怀</a></h2>
                <p class="excerpt">
                
                直接从大三的创业项目过渡目前这个创业, 来的的确有点快, 本来想一一娓娓道来，但24pi这个产品牵动着核心成员及几十万粉丝的心，请允许我写个总结. 之前的创业产品和项目一些靠谱经验会慢慢补上.
一、产品
####1.需求分析首先24pi在需求分析上做的不好，那时就是一个idea，飘飘洒洒发散了一下，就抗几把枪开始干了. 导致后来走了一段弯路, 还好发现的时候开发的周期不长, 变道比较快，如果已经开发了很长一段时间了，那么成本就上去了。 所以需求分析必须重视  !
需求分析阶段我的建议是多次头脑风暴来不断细化产品. 不断庖丁解牛，对于细化产品得粒度及广度是和几个核心人员的经验有关的, 如果第一次你可以尝试从调查目标人群、 自己身边普通用户进行黑箱调查… 切忌拍脑袋做产品.
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2015-03-08T06:34:48.000Z" class="post-list__meta--date date">3月8 2015</time> &#8226; <span class="post-list__meta--tags tags">于&nbsp;</span><a class="btn-border-small" href="/2015/03/startup-1-24pi-tearm-will-be-great/">继续阅读</a></div>
                           
            </div>
        
        
               
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2015/01/rangeerror-max-call-stack-size-exceeded-error/" title="Node.js异步回调池, Maximum call stack size exceeded error">Node.js异步回调池, Maximum call stack size exceeded error</a></h2>
                <p class="excerpt">
                
                这种错误主要发生在js调用栈的限制,如下面递归调用的代码:


(function a() {
    a();
})();



但是在Node.js中除了因为调用栈限制导致这种错误,还会因为异步回调的池满了导致这个问题,正常来说每个异步函数调用的回调函数,基本都是由事件触发回调的,这些事件触发器存在于一个地方,异步回调完成后,这个内存才会被回收.
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2015-01-17T08:12:17.000Z" class="post-list__meta--date date">1月17 2015</time> &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="-link" href="../../../tags/Node-js">Node.js</a>, <a class="-link" href="../../../tags/异常">异常</a>
</span><a class="btn-border-small" href="/2015/01/rangeerror-max-call-stack-size-exceeded-error/">继续阅读</a></div>
                       
            </div>
        
     
   
   
  
</section>

  

            <footer class="footer">
    <span class="footer__copyright">
        本站点采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
    </span>
    <span class="footer__copyright">
        基于 <a href="http://hexo.io">Hexo</a> 搭建，感谢 <a href="https://pages.github.com/">GitHub Pages</a> 提供免费的托管服务
    </span>
    <span class="footer__copyright">
        &copy; 2017 - 本站使用 <a href="https://github.com/monniya/hexo-theme-new-vno ">new-vno</a> 主题,
        由<a href="https://monniya.com ">@Monniya</a> 修改自 <a href="https://github.com/lenbo-ma/hexo-theme-vno" target="_blank">Vno</a>, 原创出自<a href="http://github.com/onevcat/vno" target="_blank">onevcat</a>
    </span>
    
</footer>


        </div>
    </div>

     
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-78918255-1', 'auto');
	ga('send', 'pageview');
</script>

    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?9cdad07c755fa23f6aced510c6760e87";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>



    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    
</body>
</html>
